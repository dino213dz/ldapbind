#!/bin/bash

# Version 1.0 20.01.2020
# CHORFA Alla-eddine
# GNU Licence
#
# https://h4ckr213dz.wordpress.com
# https://github.com/dino213dz

c='\033['
c0=$c'0m'
c1=$c'0;1;33m' #title
c2=$c'0;3;1;36m' #datas, values
c3=$c'0;3;32m' #comments
c4=$c'0;3;31m' #error

temp_file='/tmp/test.tmp'

ldapsearch_bin_path='/usr/bin/ldapsearch'


#check if can create and use temp file
touch "$temp_file"
if [ ! -f $temp_file ];then
	old_temp_file="$temp_file"
	temp_file='./test.tmp'	
	touch "$temp_file"
fi

if [ ! -f $temp_file ];then
	echo -e "ERROR: can't create temporary file in <$temp_file> or <$old_temp_file>"
	exit 4
fi

if [ ! -f $ldapsearch_bin_path ];then
	echo -e "ERROR: ldapsearch missing <$ldapsearch_bin_path>"
	echo -e "       install it with <apt install -y ldapsearch>"
	exit 3
fi

#check parameters
if [ -z ${1} ];then
	echo "Arg 1 Missing: Target"
	echo "Example: $0 ldap://challenge01.root-me.org:54013"
	exit 1
else
	target="${1}"
fi

#Showing infos
echo -e "$c1[+] Target:$c2 $target"

#scan these OU
ou_scanned=("anonymous" "users" "utilisateurs" "groups" "Groupes" "servers" "serveurs" "Computers" "Ordinateurs" "People" "Personnes" )

#Try to bind server information and get the <namingContexts> value
echo -e  "$c1[+] Getting Datas: $c2 Can take a moment, be patient please..."

namingContexts=$($ldapsearch_bin_path -H $target -x -s base '' "(objectclass=*)" "*" + 2>"$temp_file"|grep 'namingContexts:'|cut -d ' ' -f 2)
test_error=$(cat "$temp_file"|grep "Can't contact LDAP serve")

if [ ${#test_error} -gt 0 ];then
	echo -e "$c1 |_[-] ERROR:$c4 Can't contact LDAP server $c0"
	rm -f "$temp_file" 2>/dev/null
	exit 2
else
	echo -e "$c1 |_[-] Naming Contexts:$c2 $namingContexts $c0"
fi


#/usr/bin/ldapdomaindump "$target"

echo -e "$c1[+] Unauthenticated LDAP Search test:$c2 "
$ldapsearch_bin_path -H $target -x -b "$namingContexts" > "$temp_file"
test_access=$(cat "$temp_file"|grep -i "Insufficient access")

if [ ${#test_access} -gt 0 ];then
	echo -e "$c1 |_[-] ERROR:$c4 Anonymous acces refused$c0"
fi
#show results even no access
for line in $(cat "$temp_file"|sed "s/ /SP@C£/g");do
	if [ "$line" != "#" ];then
		echo -e "$c2    "$(echo -E "$line"|sed "s/SP@C£/ /g"|sed "s/^\#/\\\033[0;3;32m#/g"|sed "s/$/\n\\\033[31m/g")"$c0"
	fi
done	
echo -e "$c0"

# scan OU
echo -e "$c1[+] Scan Organisational Units:$c2"
for ous in ${ou_scanned[*]}; do
	echo '' > "$temp_file"
	echo -e "$c1---------------------------------------------"
	echo -e "$c1[-] OU:$c2 $ous"
	$ldapsearch_bin_path -H $target -x -b "ou=$ous,$namingContexts" > "$temp_file"
	nb_results=$(cat "$temp_file"|egrep -i "result.*success")
	if [ ${#nb_results} -gt 0 ];then
		for line in $(cat "$temp_file"|sed "s/ /SP@C£/g");do
			if [ "$line" != "#" ];then
				echo -e "$c2    "$(echo -E "$line"|sed "s/SP@C£/ /g"|sed "s/^\#/\\\033[0;3;32m#/g"|sed "s/$/\n\\\033[31m/g")"$c0"
			fi
		done
		echo -en "$c1[+] Continue scanning OU? [y/n]$c2 ";read continue
		if [ "${continue}" != "y" ] && [ "${continue}" != "Y" ];then
			break
		fi
	else
		echo -e "No results!"
	fi	
	
	echo -e "$c0"
done

rm -f "$temp_file" 2>/dev/null
exit 0
